## 技术方案（MySQL → 飞书多维表格）

### 1. 背景与目标
- 背景：业务数据存储在 MySQL，需要周期性同步到飞书多维表格（Bitable）用于运营看板与协作。
- 目标：提供一体化、低门槛、可观测的同步能力，支持手动执行与定时执行，失败有告警。

### 2. 总体架构
```
             +---------------------+
             |  Flask Web (UI)     |
   Web/REST  |  任务管理/状态展示     |
   --------> +---------------------+
                 | 读任务/写状态
                 v
             +---------------------+
             |  APScheduler        |  北京时区 Cron
             +---------------------+
                     |
                     v
             +---------------------+
             |  run_task 执行器     |
             |  (sync_runner.py)   |
             +---------------------+
       读SQL |     | 写Yaml+Excel | 调用子进程
             v     v              v
+------------+  +--------------------+      +----------------+
|  MySQL     |  | Excel(.xlsx in runs)| --> |  XTF 引擎      |
|  (pandas)  |  +--------------------+      |  写入飞书Bitable |
+------------+                                 +--------------+
                     失败告警(可签名)
                            |
                            v
                    飞书群机器人 Webhook
```

### 3. 核心模块
- 任务与日志（`models.py`）
  - `sync_tasks`：任务定义（SQL、模式、索引列、字段策略、Cron、是否启用、飞书链接等）
  - `sync_logs`：一次执行的开始/结束时间、状态与摘要
  - 初始化时自动建表，兼容旧库的字段自适应调整
- Web 与调度（`main.py`）
  - Flask 提供任务列表/表单、立即执行、启停与删除等
  - APScheduler 以北京时间运行 Cron 触发
  - `cn_time` 过滤器按北京时间渲染日期
- 执行器（`sync_runner.py`）
  - 读取任务 SQL，使用全局 MySQL 连接（`config.py`）
  - 将结果导出到 `runs/task_{id}.xlsx`
  - 解析飞书链接 `/base/<app_token>?table=<tbl...>`，生成 XTF YAML
  - 调用 `XTF-main/XTF.py` 子进程执行；根据输出判断成功/失败并记录
  - 失败通过飞书 Webhook 告警，支持签名
- CLI 单次执行（`mysql_to_bitable.py`）
  - 从 `_tmp_xtf_config.yaml` 读取 MySQL 源与 XTF 配置，跑单次同步
  - 执行时临时移除 `source` 并替换 `file_path`，调用 XTF 引擎

### 4. 数据/控制流程
1) 读数据：`pandas.read_sql` 执行任务 SQL（或 YAML 的 `source.sql`），拿到 DataFrame  
2) 临时文件：写入 Excel（openpyxl 引擎）到 `runs/`  
3) 生成 XTF 配置：合成 YAML，包含 `app_id/app_secret`、`app_token/table_id`、模式、索引列、字段策略、批大小、频控、重试等  
4) 执行 XTF：`subprocess.run` 启动 `XTF.py`，合并 stdout/stderr  
5) 识别结果：检测「同步完成」等成功信号，或「app secret invalid / 91403 / Traceback」等失败信号  
6) 写日志：`sync_logs` 持久化一次执行信息；失败则发飞书告警  

### 5. 同步策略与幂等
- 同步模式
  - `full`：存在记录更新；不存在新增（推荐）
  - `incremental`：仅新增，不更新
  - `overwrite`：先删目标后导入
  - `clone`：清空再导入（比 overwrite 更彻底）
- 幂等与去重
  - 依赖 `index_column` 作为唯一键进行匹配
  - 上游 SQL 需保障该列在结果集唯一
- 字段类型策略（由 XTF 执行）
  - `raw/base/auto/intelligence`，从全文本到智能推断，推荐 `base` 或 `intelligence`

### 6. 权限与安全
- 飞书权限
  - 需要对目标多维表拥有「字段创建」与「数据写入」权限
  - 遇到 91403/forbidden：将机器人加入目标多维表，授予权限
- 秘钥管理
  - `app_id/app_secret` 与 Webhook Secret 不宜明文入库，建议使用环境变量或企业密钥服务
  - 定期轮换；最小化权限范围

### 7. 时区与时间线
- 调度：APScheduler 以 Asia/Shanghai 触发
- 存库：`sync_logs` 使用「北京时间 naive datetime」，便于直接阅读与展示
- 展示：Jinja 过滤器 `cn_time` 做最终渲染

### 8. 可靠性设计
- 频控与重试：`batch_size`、`rate_limit_delay`、`max_retries` 传递给 XTF 引擎
- 失败信号：关键字识别 + 返回码；保留尾部日志片段到 `sync_logs.message`
- 告警：飞书 Webhook；支持签名（时间戳 + HMAC-SHA256）
- 容错：建表与字段补齐采用「尽力而为」策略，不阻断服务启动

### 9. 性能考量
- 读取：pandas 直连 MySQL，建议在 SQL 层做筛选与分页
- 导出：openpyxl 写入本地 Excel，I/O 较重；大体量建议分批/分片
- 写入：XTF 引擎按批提交，`batch_size` 建议 500~1000
- 限流：`rate_limit_delay` 按需上调避免被飞书限速

### 10. 可观测性
- 数据库：`sync_logs`（结构化日志）与 `sync_tasks`（配置）
- 文件：`runs/task_*.xlsx|yaml`、`logs/xtf_bitable_*.log`（XTF 生成）
- Web：最近 20 条日志可视化
- 告警：失败飞书群通知（含返回码与尾部日志）

### 11. 风险与缓解
- 权限不足：提前校验机器人在目标多维表的权限；失败消息指引
- 大表性能：限制查询范围；分批导入；非高峰调度
- 架构单点：以 systemd 或容器方式保证进程稳定；故障告警到群
- 秘钥泄露：使用环境变量与权限分离；代码仓库禁入生产密钥

### 12. 未来演进
- 增量水位（按更新时间/自增ID）
- 多源多目标（MySQL/ClickHouse → Bitable/Sheet）
- 统一配置中心与密钥服务
- 执行图与任务依赖
- 指标与监控（Prometheus/Grafana）


