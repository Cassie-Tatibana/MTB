## 开发与运维手册

本手册面向技术人员，说明部署、配置、运维与排障要点。

### 1. 环境准备
- Python 3.9+（推荐 3.10/3.11）
- MySQL 可用实例（读权限足够，推荐专库专表）
- 网络可访问飞书开放平台
- 服务器时区可为系统默认，应用内部按北京时间调度

建议创建虚拟环境并安装依赖：
```bash
python -m venv /opt/datasync/.venv
source /opt/datasync/.venv/bin/activate
pip install -U pip
pip install flask apscheduler sqlalchemy pymysql pandas openpyxl pyyaml requests
pip install -r XTF-main/requirements.txt
```

### 2. 配置管理
文件：`config.py`
- `MySQLConfig`：全局 MySQL 连接（Web 调度用）
- `FeishuConfig`：飞书 `app_id/app_secret/app_token`
- `AppConfig`：飞书群机器人 `webhook_url/webhook_secret`、运行目录等

生产建议：
- 不要在仓库明文提交生产密钥。可用环境变量注入，在 `config.py` 中优先读取 `os.getenv()`（需要你按需改造）。
- 限制数据库账号与飞书应用权限到最小集合。

### 3. 数据库与初始化
首次启动会自动建表：
- `sync_tasks`：任务表
- `sync_logs`：执行日志表

兼容逻辑：
- 缺少 `task_name/feishu_link/enabled` 字段会自动补齐
- 旧有 `app_token/table_id` 列会放宽为可空

### 4. 启动与运行
开发模式：
```bash
python main.py
# 默认 0.0.0.0:8000
```

生产模式（示例：gunicorn，无需热重载）：
```bash
gunicorn -w 2 -b 0.0.0.0:8000 main:app
```

systemd 示例（/etc/systemd/system/datasync.service）：
```
[Unit]
Description=MySQL to Feishu Bitable Sync
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/datasync
Environment="PATH=/opt/datasync/.venv/bin"
ExecStart=/opt/datasync/.venv/bin/gunicorn -w 2 -b 0.0.0.0:8000 main:app
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now datasync
```

### 5. 任务配置与调度
- Web 新建/编辑任务：SQL、同步模式、索引列、字段策略、飞书链接（`/base/<app_token>?table=<tbl...>`）、Cron
- 启用/禁用：切换 `enabled`（禁用将移除调度）
- Cron 时区：始终以北京时间触发
- 立即执行：不影响已注册的 Cron

### 6. 文件与日志
- 运行产物：`runs/task_{id}.xlsx|yaml`（覆盖式复用，避免产生冗余）
- XTF 日志：`logs/xtf_bitable_*.log`（由 XTF 引擎生成）
- 结构化日志：数据库 `sync_logs`
- Web 展示：最近 20 条日志（更多请直接查库）

### 7. 失败告警（飞书群机器人）
配置 `AppConfig.webhook_url/webhook_secret` 后，失败会推送文本消息。签名算法符合飞书文档（HMAC-SHA256，`timestamp + '\n' + secret`，消息体为空）。
- 自测脚本：`python webhook_test.py --url <url> --secret <secret>`

### 8. 常见故障与排障
1) 权限 91403 / forbidden  
   - 现象：XTF 输出含 91403/forbidden  
   - 原因：机器人对目标多维表缺少「字段创建」或写入权限  
   - 处理：将机器人加入目标多维表，并授予相应权限

2) `app secret invalid` / 获取访问令牌失败  
   - 检查 `FeishuConfig.app_id/app_secret` 是否正确、是否已在飞书开放平台启用应用

3) SQL 结果为空  
   - 检查 SQL 与连接；本系统会直接退出且不报错（可视为成功但无变更）

4) Excel 写入失败  
   - 安装 `openpyxl`；检查磁盘空间与写权限

5) 被飞书限速  
   - 调整 YAML/任务配置中的 `batch_size`、`rate_limit_delay`；分时调度

6) 进程异常退出  
   - systemd 确保自动拉起；从 `sync_logs` 与 `logs/` 中定位原因

### 9. 数据校验与回滚
- 抽样比对：在飞书多维表中抽样核对关键字段
- 回滚策略：若使用 `full` 模式，可复用上一次 Excel 产物重新导入；如 `clone/overwrite` 造成清空，需要依赖源数据重新回灌

### 10. 备份与恢复
- 配置备份：导出/备份 `sync_tasks` 表（或通过 UI 导出）
- 日志备份：`sync_logs` 可按周期归档至冷存/对象存储
- 恢复：先恢复任务配置，再按需重新执行任务

### 11. 升级与发布
- 下线变更窗口：备份数据库（至少 `sync_tasks`）
- 代码更新：拉取新代码并 `pip install -r XTF-main/requirements.txt`（如有变更）
- 兼容：`init_db()` 会进行轻量字段自适应；如有破坏性升级需提前公告
- 回滚：保留上一版本代码与虚拟环境快照

### 12. 监控与SLA建议
- KPI：成功率、平均耗时、导入行数、失败原因分布
- 告警：失败立即群通知；重复失败阈值触发升级通道
- 巡检：定期检查 `sync_tasks` 启用状态与 Cron 配置


