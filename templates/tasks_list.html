<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>DataSync Scheduler</title>
  <style>
    :root {
      --brand: #1677ff;
      --text: #1f2329;
      --muted: #646a73;
      --border: #e5e6eb;
      --bg: #f7f8fa;
      --success: #00b578;
      --danger: #ff4d4f;
      --warning: #ffb400;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 24px; background: var(--bg); color: var(--text); }
    .card { background:#fff; border:1px solid var(--border); border-radius: 12px; padding: 16px; }
    .table-wrap { margin-top: 16px; border-radius: 12px; overflow: hidden; border:1px solid var(--border); }
    table { border-collapse: collapse; width: 100%; background:#fff; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px 12px; text-align: left; }
    th { background: #fafafa; font-weight:600; }
    tr:hover td { background: #fafcff; }
    .toolbar { margin-bottom: 16px; display:flex; gap:8px; }
    .btn { display: inline-block; padding: 6px 12px; border: 1px solid var(--border); border-radius: 8px; text-decoration: none; color: var(--text); background:#fff; }
    .btn:hover { border-color: var(--brand); }
    .btn-primary { background: var(--brand); color: #fff; border-color: var(--brand); }
    .btn-danger { background:#fff; color: var(--danger); border-color: var(--danger); }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; display:inline-block; }
    .badge-success { background: #e8fff3; color: var(--success); border:1px solid #b7f2d9; }
    .badge-fail { background: #fff1f0; color: var(--danger); border:1px solid #ffd5d2; }
    .muted { color: var(--muted); font-size: 12px; }
    .switch-on { background: var(--brand); color:#fff; border-color: var(--brand); }
    .switch-off { background:#fff; color: var(--muted); }
    .actions form { display:inline; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="toolbar">
    <h2 style="margin:0; flex:1;">DataSync Scheduler</h2>
    <a class="btn" href="/">ğŸ”„ åˆ·æ–°</a>
    <a class="btn btn-primary" href="/tasks/new">â• æ–°å»ºä»»åŠ¡</a>
  </div>
  <div class="card">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul>
        {% for category, message in messages %}
          <li>[{{ category }}] {{ message }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <h3>ä»»åŠ¡åˆ—è¡¨</h3>
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>åç§°</th>
        <th>åŒæ­¥æ¨¡å¼</th>
        <th>ç´¢å¼•åˆ—</th>
        <th>å­—æ®µç­–ç•¥</th>
        <th>é£ä¹¦é“¾æ¥</th>
        <th>å¯ç”¨çŠ¶æ€</th>
        <th>Cron</th>
        <th>ä¸Šæ¬¡çŠ¶æ€</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      {% for t in tasks %}
      <tr>
        <td>{{ t.id }}</td>
        <td>{{ t.name }}</td>
        <td>{{ t.sync_mode }}</td>
        <td>{{ t.index_column }}</td>
        <td>{{ t.field_type_strategy }}</td>
        <td style="max-width:320px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="{{ t.feishu_link or '' }}">
          {% if t.feishu_link %}
            <a href="{{ t.feishu_link }}" target="_blank" rel="noopener noreferrer">{{ t.feishu_link }}</a>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          <form style="display:inline;" method="post" action="/tasks/{{ t.id }}/toggle">
            {% if t.enabled %}
              <button class="btn switch-on" type="submit" title="ç‚¹å‡»åˆ‡æ¢ä¸ºæœªå¯ç”¨">å·²å¯ç”¨</button>
            {% else %}
              <button class="btn switch-off" type="submit" title="ç‚¹å‡»åˆ‡æ¢ä¸ºå¯ç”¨">æœªå¯ç”¨</button>
            {% endif %}
          </form>
        </td>
        <td>{{ t.cron_expr }}</td>
        <td>
          {% if t.last_run_status == 'success' %}
            <span class="badge badge-success">success</span>
          {% elif t.last_run_status == 'fail' %}
            <span class="badge badge-fail">fail</span>
          {% else %}
            <span class="muted">{{ t.last_run_status or '-' }}</span>
          {% endif %}
        </td>
        <td class="actions">
          <a class="btn" href="/tasks/{{ t.id }}/edit">ç¼–è¾‘</a>
          <form style="display:inline;" method="post" action="/tasks/{{ t.id }}/run">
            <button class="btn btn-primary" type="submit">ç«‹å³æ‰§è¡Œ</button>
          </form>
          <form style="display:inline;" method="post" action="/tasks/{{ t.id }}/delete" onsubmit="return confirm('ç¡®è®¤åˆ é™¤è¯¥ä»»åŠ¡ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤');">
            <button class="btn" type="submit">åˆ é™¤ä»»åŠ¡</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>

  <h3 style="margin-top:32px;">æœ€è¿‘æ—¥å¿—</h3>
  <p class="muted" style="margin: 6px 0 0 0;">ä»…å±•ç¤ºæœ€è¿‘ 20 æ¡æ—¥å¿—ã€‚æ›´å¤šæ—¥å¿—è¯·åˆ°æ•°æ®åº“ <code>mysql_to_bitable.sync_logs</code> æŸ¥è¯¢ã€‚</p>
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>TaskID</th>
        <th>ä»»åŠ¡åç§°</th>
        <th>å¼€å§‹æ—¶é—´</th>
        <th>ç»“æŸæ—¶é—´</th>
        <th>çŠ¶æ€</th>
        <th>æ‘˜è¦</th>
      </tr>
    </thead>
    <tbody>
      {% for l in logs %}
      <tr>
        <td>{{ l.id }}</td>
        <td>{{ l.task_id }}</td>
        <td>{{ l.task_name or '-' }}</td>
        <td>{{ l.start_time|cn_time }}</td>
        <td>{{ l.end_time|cn_time }}</td>
        <td>
          {% if l.status == 'success' %}
            <span class="badge badge-success">success</span>
          {% elif l.status == 'fail' %}
            <span class="badge badge-fail">fail</span>
          {% else %}
            <span class="muted">{{ l.status or '-' }}</span>
          {% endif %}
        </td>
        <td style="max-width:600px; white-space: pre; overflow: auto;">{{ l.message or '' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  </div>
</body>
</html>


